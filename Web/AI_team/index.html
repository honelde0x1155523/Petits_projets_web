<!doctype html>
<html lang="fr">

<head>
	<meta charset="utf-8">
	<title>Simu Entreprise – Orchestrateur</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
	<style>
		body {
			background: #f7f9fc
		}

		.mono {
			font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
		}

		.offcanvas-start {
			width: 300px
		}
	</style>
</head>

<body>
	<nav class="navbar navbar-light bg-white border-bottom sticky-top">
		<div class="container-fluid">
			<button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#menu">☰</button>
			<span class="navbar-brand mb-0 h1">Simu Entreprise</span>
			<div class="d-flex gap-2">
				<button id="btnRender" class="btn btn-success btn-sm">Afficher</button>
				<button id="btnStartSprint" class="btn btn-primary btn-sm d-none">Commencer le sprint</button>
				<button id="btnNextSprint" class="btn btn-outline-primary btn-sm d-none">Sprint suivant</button>
				<button id="btnPause" class="btn btn-outline-warning btn-sm d-none">Mettre en pause</button>
				<button id="btnEnd" class="btn btn-outline-danger btn-sm d-none">Mettre fin</button>
			</div>
		</div>
	</nav>

	<div class="offcanvas offcanvas-start" tabindex="-1" id="menu">
		<div class="offcanvas-header">
			<h5 class="offcanvas-title">Projets</h5>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
		</div>
		<div class="offcanvas-body">
			<div id="projectsList" class="small text-muted">Aucun projet chargé.</div>
		</div>
	</div>

	<main class="container my-4">
		<div class="row g-4">
			<div class="col-12">
				<label for="configInput" class="form-label">Configuration (JSON ou YAML)</label>
				<textarea id="configInput" class="form-control mono" rows="10"
					placeholder="Collez ici votre config..."></textarea>
				<div class="form-text">Le CHEF initiera le premier message. Le back orchestre tout.</div>
			</div>
			<div class="col-12">
				<div id="alertZone"></div>
			</div>

			<div class="col-12 col-lg-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Projet</h5>
						<div id="projectPanel" class="small text-muted">Aucune configuration chargée.</div>
					</div>
				</div>
			</div>

			<div class="col-12 col-lg-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Rôles</h5>
						<div id="rolesPanel" class="small text-muted">—</div>
					</div>
				</div>
			</div>

			<div class="col-12 col-lg-4">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Équipe</h5>
						<div id="teamPanel" class="small text-muted">—</div>
					</div>
				</div>
			</div>

			<div class="col-12">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Workflow</h5>
						<div id="workflowPanel" class="small text-muted">—</div>
					</div>
				</div>
			</div>

			<div class="col-12">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Conversation du sprint (lecture seule)</h5>
						<div id="chatView" class="border p-2" style="height:300px; overflow-y:auto; background:#fff;"></div>
					</div>
				</div>
			</div>
		</div>
	</main>

	<footer class="container my-4 text-center text-muted small">
		Stockage serveur par projet (JSON+sprints, livrables/ avec git). Le front n’orchestré pas, il affiche.
	</footer>

	<script>
		let currentConfig = null;
		let currentProjectId = null;
		let pollTimer = null;

		function showAlert(kind, title, details = []) {
			const z = document.getElementById('alertZone');
			const list = details.map(d => `<li>${escapeHtml(String(d))}</li>`).join('');
			z.innerHTML = `
      <div class="alert alert-${kind}"><strong>${escapeHtml(title)}</strong>
      ${details.length ? `<ul class="mb-0">${list}</ul>` : ''}</div>`;
		}
		function clearAlerts() {document.getElementById('alertZone').innerHTML = '';}
		function escapeHtml(s) {return String(s).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));}

		function parseConfig(raw) {
			const t = (raw || '').trim();
			if (!t) throw new Error('Configuration vide.');
			if (/^\s*[\{\[]/.test(t)) return JSON.parse(t);
			return jsyaml.load(t);
		}

		function validate(cfg) {
			const issues = [];
			['company', 'project', 'roles', 'employees'].forEach(k => {if (!(k in cfg)) issues.push(`Manque: ${k}`);});
			if (cfg.project) {['name', 'goal', 'description'].forEach(k => {if (!(k in cfg.project)) issues.push(`project.${k} manquant`);});}
			if (!Array.isArray(cfg.roles)) issues.push('roles doit être une liste');
			if (!Array.isArray(cfg.employees)) issues.push('employees doit être une liste');
			return issues;
		}

		function renderUI(cfg) {
			const p = cfg.project || {};
			document.getElementById('projectPanel').innerHTML = `
      <div><strong>Entreprise :</strong> ${escapeHtml(cfg.company || '—')}</div>
      <div><strong>Nom du projet :</strong> ${escapeHtml(p.name || '—')}</div>
      <div><strong>Objectif :</strong> ${escapeHtml(p.goal || '—')}</div>
      <div class="mt-2">${escapeHtml(p.description || '')}</div>`;
			const roles = Array.isArray(cfg.roles) ? cfg.roles : [];
			document.getElementById('rolesPanel').innerHTML = roles.length ? roles.map(r => `
      <div class="border rounded p-2 mb-2">
        <div><strong>${escapeHtml(r.name)}</strong> <span class="badge bg-secondary">${escapeHtml(r.id)}</span></div>
        <div class="text-muted small">${escapeHtml(r.description || '—')}</div>
      </div>`).join('') : 'Aucun rôle.';
			const emps = Array.isArray(cfg.employees) ? cfg.employees : [];
			document.getElementById('teamPanel').innerHTML = emps.length ? `
      <div class="table-responsive"><table class="table table-sm">
        <thead><tr><th>Nom</th><th>Rôle</th><th>Id</th></tr></thead>
        <tbody>${emps.map(u => `<tr><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.roleId)}</td><td class="text-muted">${escapeHtml(u.id)}</td></tr>`).join('')}</tbody>
      </table></div>` : 'Aucun employé.';
			const stages = (cfg.workflow && Array.isArray(cfg.workflow.stages)) ? cfg.workflow.stages : [];
			document.getElementById('workflowPanel').innerHTML = stages.length ? stages.map((s, i) => `
      <span class="badge rounded-pill bg-${i === stages.length - 1 ? 'success' : 'info'} me-1 mb-1">${escapeHtml(s)}</span>`).join('') : '—';
		}

		async function initProject(cfg) {
			const r = await fetch('/api/project/init', {
				method: 'POST', headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({config: cfg})
			});
			const data = await r.json();
			if (!r.ok) throw new Error(data.error || 'Init échouée');
			return data.projectId;
		}

		async function startSprint(projectId) {
			const r = await fetch('/api/sprint/start', {
				method: 'POST', headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({projectId})
			});
			const data = await r.json();
			if (!r.ok) throw new Error(data.error || 'Start sprint échoué');
			return data;
		}

		async function getState(projectId) {
			const r = await fetch(`/api/project/${encodeURIComponent(projectId)}/state`);
			const data = await r.json();
			if (!r.ok) throw new Error(data.error || 'State échoué');
			return data;
		}

		function renderChat(sprint) {
			const box = document.getElementById('chatView');
			if (!sprint) {box.textContent = '—'; return;}
			const lines = (sprint.messages || []).map(m => `<div><strong>${escapeHtml(m.roleId)}:</strong> ${escapeHtml(m.content)}</div>`);
			box.innerHTML = lines.join('');
			box.scrollTop = box.scrollHeight;
		}

		function setButtons(meta) {
			const btnStart = document.getElementById('btnStartSprint');
			const btnNext = document.getElementById('btnNextSprint');
			const btnPause = document.getElementById('btnPause');
			const btnEnd = document.getElementById('btnEnd');

			// Affichages selon status
			btnStart.classList.toggle('d-none', !(meta.status === 'idle' || meta.currentSprint === 0));
			btnNext.classList.toggle('d-none', !(meta.status === 'idle' && meta.currentSprint > 0));
			btnPause.classList.toggle('d-none', !(meta.status === 'running'));
			btnEnd.classList.toggle('d-none', !(meta.status !== 'ended'));
		}

		function startPolling() {
			stopPolling();
			pollTimer = setInterval(async () => {
				if (!currentProjectId) return;
				try {
					const st = await getState(currentProjectId);
					renderChat(st.sprint);
					setButtons(st.meta);
				} catch (e) {
					console.error(e);
				}
			}, 2000);
		}
		function stopPolling() {if (pollTimer) {clearInterval(pollTimer); pollTimer = null;} }

		document.getElementById('btnRender').addEventListener('click', async () => {
			clearAlerts();
			try {
				const cfg = parseConfig(document.getElementById('configInput').value);
				const issues = validate(cfg);
				if (issues.length) {showAlert('warning', 'Validation partielle', issues);}
				renderUI(cfg);
				currentConfig = cfg;
				// Init projet serveur
				currentProjectId = await initProject(cfg);
				showAlert('success', `Projet initialisé: ${currentProjectId}`);
				document.getElementById('btnStartSprint').classList.remove('d-none');
				startPolling();
			} catch (e) {
				showAlert('danger', 'Erreur', [String(e)]);
			}
		});

		document.getElementById('btnStartSprint').addEventListener('click', async () => {
			if (!currentProjectId) return;
			try {
				await startSprint(currentProjectId);
				showAlert('info', 'Sprint démarré');
			} catch (e) {
				showAlert('danger', 'Démarrage sprint échoué', [String(e)]);
			}
		});

		document.getElementById('btnNextSprint').addEventListener('click', async () => {
			if (!currentProjectId) return;
			const r = await fetch('/api/sprint/next', {
				method: 'POST', headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({projectId: currentProjectId})
			});
			const data = await r.json();
			if (!r.ok) showAlert('danger', 'Sprint suivant échoué', [data.error || '']);
			else showAlert('info', 'Sprint suivant démarré');
		});

		document.getElementById('btnPause').addEventListener('click', async () => {
			if (!currentProjectId) return;
			const r = await fetch('/api/project/pause', {
				method: 'POST', headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({projectId: currentProjectId})
			});
			const data = await r.json();
			if (!r.ok) showAlert('danger', 'Pause échouée', [data.error || '']);
			else showAlert('info', 'Projet en pause');
		});

		document.getElementById('btnEnd').addEventListener('click', async () => {
			if (!currentProjectId) return;
			const r = await fetch('/api/project/end', {
				method: 'POST', headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({projectId: currentProjectId})
			});
			const data = await r.json();
			if (!r.ok) showAlert('danger', 'Fin projet échouée', [data.error || '']);
			else showAlert('info', 'Projet terminé');
		});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
